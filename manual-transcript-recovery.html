<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manual Transcript Recovery by ID</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-8 mb-6">
      <h1 class="text-3xl font-bold text-blue-900 mb-4">üéØ Manual Transcript Recovery</h1>
      <p class="text-blue-800 mb-2">
        If the automatic scanner isn't finding your streaming transcripts, you can manually enter their IDs here.
      </p>
      <div class="bg-white rounded p-4 mt-4 text-sm">
        <div class="font-bold mb-2">How to find transcript IDs in Assembly AI Dashboard:</div>
        <ol class="list-decimal list-inside space-y-1 text-gray-700">
          <li>Go to <a href="https://www.assemblyai.com/app/transcripts" target="_blank" class="text-blue-600 underline">Assembly AI Transcripts</a></li>
          <li>Click on each transcript</li>
          <li>Copy the transcript ID from the URL or page</li>
          <li>Paste them below (one per line)</li>
        </ol>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Assembly AI API Key
        </label>
        <input
          type="password"
          id="apiKey"
          value="95b4727b94534ba492e273b2af713159"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Transcript IDs (one per line)
        </label>
        <textarea
          id="transcriptIds"
          rows="15"
          placeholder="4f8c4e19-44b1-4c99-b9bb-8549d4faf3ad
2cad96ef-4bf1-481f-9de9-2c0a22da0e27
abc123def456..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
        ></textarea>
        <p class="text-xs text-gray-500 mt-1">
          Paste all your transcript IDs here, one per line. You can find these in your Assembly AI dashboard.
        </p>
      </div>

      <button
        onclick="recoverTranscripts()"
        class="w-full bg-green-600 text-white py-4 px-6 rounded-lg hover:bg-green-700 transition-colors font-bold text-xl"
      >
        üîÑ RECOVER ALL TRANSCRIPTS
      </button>
    </div>

    <div id="progress" class="hidden mb-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center space-x-3 mb-4">
          <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <span class="text-gray-700 font-medium text-lg">Recovering transcripts...</span>
        </div>
        <div id="progressLog" class="text-sm text-gray-600 space-y-1 max-h-96 overflow-y-auto bg-gray-50 p-4 rounded"></div>
      </div>
    </div>

    <div id="results" class="hidden"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('progressLog')
      if (!logDiv) return
      const line = document.createElement('div')
      line.textContent = message
      line.className = type === 'error' ? 'text-red-600 font-medium' :
                       type === 'success' ? 'text-green-600 font-medium' :
                       type === 'warning' ? 'text-yellow-600' : 'text-gray-700'
      logDiv.appendChild(line)
      logDiv.scrollTop = logDiv.scrollHeight
      console.log(message)
    }

    async function recoverTranscripts() {
      const apiKey = document.getElementById('apiKey').value.trim()
      const transcriptIdsText = document.getElementById('transcriptIds').value.trim()

      if (!apiKey) {
        alert('Please enter your Assembly AI API key')
        return
      }

      if (!transcriptIdsText) {
        alert('Please enter at least one transcript ID')
        return
      }

      // Parse transcript IDs (one per line, trim whitespace, remove empty lines)
      const transcriptIds = transcriptIdsText
        .split('\n')
        .map(id => id.trim())
        .filter(id => id.length > 0)
        .filter(id => !id.startsWith('#')) // Allow comments

      if (transcriptIds.length === 0) {
        alert('No valid transcript IDs found')
        return
      }

      document.getElementById('progress').classList.remove('hidden')
      document.getElementById('results').classList.add('hidden')
      document.getElementById('progressLog').innerHTML = ''

      log(`üîÑ Starting recovery of ${transcriptIds.length} transcripts...`, 'success')
      log(`Transcript IDs to recover: ${transcriptIds.length}`)
      log('')

      const recoveredMeetings = []
      const errors = []

      for (let i = 0; i < transcriptIds.length; i++) {
        const transcriptId = transcriptIds[i]
        log(`[${i + 1}/${transcriptIds.length}] Fetching ${transcriptId}...`)

        try {
          const response = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
            headers: { authorization: apiKey }
          })

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const transcript = await response.json()

          if (transcript.status === 'completed') {
            const meeting = convertTranscriptToMeeting(transcript)
            recoveredMeetings.push(meeting)

            const wordCount = meeting.wordCount || 0
            const speakerCount = meeting.speakerCount || 0
            const duration = meeting.duration || 0

            log(`  ‚úÖ Recovered: ${wordCount} words, ${speakerCount} speakers, ${duration}s`, 'success')
          } else {
            log(`  ‚ö†Ô∏è Status: ${transcript.status} (not completed)`, 'warning')
            errors.push({ transcriptId, error: `Status: ${transcript.status}` })
          }

        } catch (error) {
          log(`  ‚ùå Failed: ${error.message}`, 'error')
          errors.push({ transcriptId, error: error.message })
        }
      }

      log('')
      log(`üéâ RECOVERY COMPLETE!`, 'success')
      log(`  ‚úÖ Successful: ${recoveredMeetings.length}`, 'success')
      log(`  ‚ùå Failed: ${errors.length}`, 'error')

      document.getElementById('progress').classList.add('hidden')

      if (recoveredMeetings.length > 0) {
        showResults(recoveredMeetings, errors)
      } else {
        alert('No transcripts were recovered successfully. Check the log for details.')
      }
    }

    function convertTranscriptToMeeting(transcript) {
      const now = new Date().toISOString()
      const createdDate = new Date(transcript.created)

      const speakers = new Set()
      if (transcript.utterances) {
        transcript.utterances.forEach(u => speakers.add(u.speaker))
      }

      let formattedTranscript = ''
      if (transcript.utterances && transcript.utterances.length > 0) {
        formattedTranscript = transcript.utterances.map(u =>
          `[Speaker ${u.speaker}]: ${u.text}`
        ).join('\n\n')
      } else {
        formattedTranscript = transcript.text || ''
      }

      return {
        id: generateUUID(),
        title: `Meeting - ${createdDate.toLocaleDateString()} ${createdDate.toLocaleTimeString()}`,
        description: `Recovered from Assembly AI (ID: ${transcript.id})`,
        date: createdDate.toISOString().split('T')[0],
        audioTranscript: formattedTranscript,
        transcript: formattedTranscript,
        duration: transcript.audio_duration ? Math.round(transcript.audio_duration) : null,
        wordCount: transcript.text ? transcript.text.split(' ').length : 0,
        speakerCount: speakers.size,
        confidence: transcript.confidence,
        createdAt: transcript.created,
        updatedAt: now,
        lastSaved: now,
        originalInputs: {
          audioTranscript: formattedTranscript,
          manualText: '',
          ocrText: ''
        },
        utterances: transcript.utterances || [],
        words: transcript.words || [],
        speakerData: transcript.utterances ? {
          utterances: transcript.utterances,
          speakers_detected: speakers.size
        } : null,
        metadata: {
          recovered: true,
          recoveredAt: now,
          assemblyAIId: transcript.id,
          originalStatus: transcript.status,
          speakerLabels: Array.from(speakers).map(s => `Speaker ${s}`),
          audioUrl: transcript.audio_url
        }
      }
    }

    function showResults(meetings, errors) {
      const resultsDiv = document.getElementById('results')
      resultsDiv.classList.remove('hidden')

      const script = generateImportScript(meetings)

      resultsDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6 mb-6">
            <h3 class="text-2xl font-bold text-green-900 mb-4">‚úÖ Successfully Recovered ${meetings.length} Meetings!</h3>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              ${meetings.map((m, i) => `
                <div class="bg-white rounded p-3 border border-green-200">
                  <div class="font-medium text-gray-900">${i + 1}. ${m.title}</div>
                  <div class="text-sm text-gray-600">
                    ${m.wordCount} words ‚Ä¢ ${m.speakerCount} speakers ‚Ä¢ ${m.duration}s ‚Ä¢ ${m.date}
                  </div>
                  <div class="text-xs text-gray-500 mt-1 font-mono">ID: ${m.metadata.assemblyAIId}</div>
                </div>
              `).join('')}
            </div>
          </div>

          ${errors.length > 0 ? `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
              <h4 class="font-bold text-red-900 mb-2">‚ö†Ô∏è ${errors.length} Failed</h4>
              <div class="space-y-1 max-h-64 overflow-y-auto">
                ${errors.map(e => `
                  <div class="text-sm text-red-700 font-mono">‚Ä¢ ${e.transcriptId}: ${e.error}</div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
            <h3 class="text-xl font-bold text-blue-900 mb-4">üìã Import Script</h3>
            <p class="text-sm text-blue-800 mb-3">
              Copy this script and paste it in your MeetingFlow app console (F12):
            </p>
            <textarea
              id="importScript"
              readonly
              class="w-full h-64 p-4 font-mono text-xs bg-white border-2 border-blue-200 rounded mb-4"
            >${script}</textarea>
            <div class="flex gap-3">
              <button
                onclick="copyImportScript()"
                class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 font-bold"
              >
                üìã Copy to Clipboard
              </button>
              <button
                onclick="downloadImportScript()"
                class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 font-bold"
              >
                üíæ Download Script
              </button>
            </div>
          </div>

          <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-6">
            <p class="text-sm text-yellow-700 font-medium mb-2">üìù Next Steps:</p>
            <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700">
              <li>Copy the script above</li>
              <li>Open: <a href="https://sudhanshumalani.github.io/meetingflow-app" target="_blank" class="text-blue-600 underline font-medium">MeetingFlow App</a></li>
              <li>Press F12 ‚Üí Console</li>
              <li>Paste and press Enter</li>
              <li>Refresh (F5)</li>
              <li>Your meetings will appear!</li>
            </ol>
          </div>
        </div>
      `

      resultsDiv.scrollIntoView({ behavior: 'smooth' })
    }

    function generateImportScript(meetings) {
      return `// IMPORT RECOVERED MEETINGS FROM ASSEMBLY AI
// Generated: ${new Date().toISOString()}
// Meetings: ${meetings.length}

(function() {
  console.log('üîÑ Importing ${meetings.length} recovered meetings from Assembly AI...')

  const recoveredMeetings = ${JSON.stringify(meetings, null, 2)}

  const existingMeetings = JSON.parse(localStorage.getItem('meetingflow_meetings') || '[]')
  console.log('Current meetings in app:', existingMeetings.length)

  const existingAssemblyIds = new Set(
    existingMeetings
      .filter(m => m.metadata?.assemblyAIId)
      .map(m => m.metadata.assemblyAIId)
  )

  let imported = 0
  let skipped = 0

  recoveredMeetings.forEach(meeting => {
    if (existingAssemblyIds.has(meeting.metadata.assemblyAIId)) {
      console.log('‚è≠Ô∏è Skipping duplicate:', meeting.metadata.assemblyAIId)
      skipped++
    } else {
      existingMeetings.unshift(meeting)
      console.log('‚úÖ Imported:', meeting.title, '(' + meeting.wordCount + ' words)')
      imported++
    }
  })

  localStorage.setItem('meetingflow_meetings', JSON.stringify(existingMeetings))

  console.log('')
  console.log('üìä IMPORT COMPLETE!')
  console.log('  ‚úÖ Imported:', imported)
  console.log('  ‚è≠Ô∏è Skipped (duplicates):', skipped)
  console.log('  üìù Total meetings now:', existingMeetings.length)

  window.dispatchEvent(new CustomEvent('meetingflow-storage-updated', {
    detail: {
      source: 'assembly-ai-recovery',
      operation: 'import',
      imported: imported,
      skipped: skipped
    }
  }))

  alert(\`‚úÖ IMPORT COMPLETE!\\n\\n‚úÖ Imported: \${imported} meetings\\n‚è≠Ô∏è Skipped: \${skipped} duplicates\\nüìù Total: \${existingMeetings.length} meetings\\n\\nüîÑ Refresh (F5) to see them!\`)
})()
`
    }

    function copyImportScript() {
      const textarea = document.getElementById('importScript')
      textarea.select()
      document.execCommand('copy')
      alert('‚úÖ Script copied!\n\nNow:\n1. Open your app\n2. F12 ‚Üí Console\n3. Paste & Enter\n4. Refresh (F5)')
    }

    function downloadImportScript() {
      const script = document.getElementById('importScript').value
      const blob = new Blob([script], { type: 'text/javascript' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `meetingflow-recovery-${Date.now()}.js`
      a.click()
      URL.revokeObjectURL(url)
      alert('‚úÖ Downloaded!')
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8)
        return v.toString(16)
      })
    }
  </script>
</body>
</html>
