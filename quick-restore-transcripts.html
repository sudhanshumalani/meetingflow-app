<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Restore - Assembly AI Transcripts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-8 mb-6">
      <h1 class="text-3xl font-bold text-red-900 mb-4">üö® Quick Restore - Assembly AI Transcripts</h1>
      <p class="text-red-800 mb-2">
        This will recover your 2 specific transcripts directly from Assembly AI servers.
      </p>
      <div class="bg-white rounded p-3 mt-3 text-sm font-mono">
        <div>1. 4f8c4e19-44b1-4c99-b9bb-8549d4faf3ad</div>
        <div>2. 2cad96ef-4bf1-481f-9de9-2c0a22da0e27</div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-8 space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Assembly AI API Key
        </label>
        <input
          type="password"
          id="apiKey"
          value="95b4727b94534ba492e273b2af713159"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <button
        onclick="quickRestore()"
        class="w-full bg-red-600 text-white py-4 px-6 rounded-lg hover:bg-red-700 transition-colors font-bold text-xl"
      >
        üîÑ RESTORE THESE 2 MEETINGS NOW
      </button>

      <div id="progress" class="hidden">
        <div class="bg-gray-100 rounded-lg p-4">
          <div class="flex items-center space-x-3 mb-2">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            <span class="text-gray-700 font-medium">Recovering transcripts...</span>
          </div>
          <div id="progressLog" class="text-sm text-gray-600 space-y-1 max-h-64 overflow-y-auto"></div>
        </div>
      </div>

      <div id="results" class="hidden"></div>
    </div>

    <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <p class="text-sm text-yellow-700">
        <strong>This will only recover these 2 specific meetings.</strong><br>
        For your other meetings, we need to check localforage or your mobile device.
      </p>
    </div>
  </div>

  <script>
    const transcriptIds = [
      '4f8c4e19-44b1-4c99-b9bb-8549d4faf3ad',
      '2cad96ef-4bf1-481f-9de9-2c0a22da0e27'
    ]

    function log(message, type = 'info') {
      const logDiv = document.getElementById('progressLog')
      if (!logDiv) return
      const line = document.createElement('div')
      line.textContent = message
      line.className = type === 'error' ? 'text-red-600' :
                       type === 'success' ? 'text-green-600' : 'text-gray-600'
      logDiv.appendChild(line)
      logDiv.scrollTop = logDiv.scrollHeight
      console.log(message)
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8)
        return v.toString(16)
      })
    }

    async function fetchTranscript(transcriptId, apiKey) {
      log(`üì• Fetching: ${transcriptId}`)

      const response = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
        headers: { authorization: apiKey }
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }

      const transcript = await response.json()

      if (transcript.status === 'completed') {
        log(`‚úÖ Retrieved: ${transcript.text?.split(' ').length || 0} words`, 'success')
        return transcript
      } else if (transcript.status === 'error') {
        throw new Error(`Transcript error: ${transcript.error}`)
      } else {
        throw new Error(`Transcript status: ${transcript.status}`)
      }
    }

    function convertToMeeting(transcript, transcriptId) {
      const now = new Date().toISOString()

      const speakers = new Set()
      if (transcript.utterances) {
        transcript.utterances.forEach(u => speakers.add(u.speaker))
      }

      let formattedTranscript = ''
      if (transcript.utterances && transcript.utterances.length > 0) {
        formattedTranscript = transcript.utterances.map(u =>
          `[Speaker ${u.speaker}]: ${u.text}`
        ).join('\n\n')
      } else {
        formattedTranscript = transcript.text || ''
      }

      return {
        id: generateUUID(),
        title: `Recovered Meeting - ${new Date().toLocaleDateString()}`,
        description: `Recovered from Assembly AI (ID: ${transcriptId})`,
        date: new Date().toISOString().split('T')[0],
        audioTranscript: formattedTranscript,
        transcript: formattedTranscript,
        duration: transcript.audio_duration ? Math.round(transcript.audio_duration) : null,
        wordCount: transcript.text ? transcript.text.split(' ').length : 0,
        speakerCount: speakers.size,
        confidence: transcript.confidence,
        createdAt: now,
        updatedAt: now,
        lastSaved: now,
        originalInputs: {
          audioTranscript: formattedTranscript,
          manualText: '',
          ocrText: ''
        },
        utterances: transcript.utterances || [],
        words: transcript.words || [],
        speakerData: transcript.utterances ? {
          utterances: transcript.utterances,
          speakers_detected: speakers.size
        } : null,
        metadata: {
          recovered: true,
          recoveredAt: now,
          assemblyAIId: transcriptId,
          originalStatus: transcript.status,
          speakerLabels: Array.from(speakers).map(s => `Speaker ${s}`)
        }
      }
    }

    async function quickRestore() {
      const apiKey = document.getElementById('apiKey').value.trim()

      if (!apiKey) {
        alert('Please enter API key')
        return
      }

      document.getElementById('progress').classList.remove('hidden')
      document.getElementById('results').classList.add('hidden')
      document.getElementById('progressLog').innerHTML = ''

      const recoveredMeetings = []
      const errors = []

      for (const transcriptId of transcriptIds) {
        try {
          const transcript = await fetchTranscript(transcriptId, apiKey)
          const meeting = convertToMeeting(transcript, transcriptId)
          recoveredMeetings.push(meeting)
          log(`‚úÖ Recovered: ${meeting.wordCount} words, ${meeting.speakerCount} speakers`, 'success')
        } catch (error) {
          log(`‚ùå Failed: ${error.message}`, 'error')
          errors.push({ transcriptId, error: error.message })
        }
      }

      showResults(recoveredMeetings, errors)
    }

    function showResults(meetings, errors) {
      document.getElementById('progress').classList.add('hidden')
      document.getElementById('results').classList.remove('hidden')

      const resultsDiv = document.getElementById('results')

      if (meetings.length === 0) {
        resultsDiv.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="text-lg font-bold text-red-900 mb-2">‚ùå Recovery Failed</h3>
            <p class="text-red-800">Could not recover any transcripts.</p>
            ${errors.map(e => `<div class="text-sm mt-2">‚Ä¢ ${e.transcriptId}: ${e.error}</div>`).join('')}
          </div>
        `
        return
      }

      // Generate import script
      const script = `
// RESTORE RECOVERED MEETINGS
(function() {
  console.log('üîÑ Restoring ${meetings.length} meetings from Assembly AI...')

  const recoveredMeetings = ${JSON.stringify(meetings, null, 2)}

  // Get existing meetings
  const existingMeetings = JSON.parse(localStorage.getItem('meetingflow_meetings') || '[]')

  // Add recovered meetings to the beginning
  const updatedMeetings = [...recoveredMeetings, ...existingMeetings]

  // Save back
  localStorage.setItem('meetingflow_meetings', JSON.stringify(updatedMeetings))

  console.log('‚úÖ Restored ${meetings.length} meetings!')
  console.log('Total meetings now:', updatedMeetings.length)

  // Trigger storage event
  window.dispatchEvent(new CustomEvent('meetingflow-storage-updated', {
    detail: { source: 'recovery', operation: 'restore' }
  }))

  alert('‚úÖ Restored ${meetings.length} meetings!\\n\\nüîÑ Refresh the page (F5) to see them.')
})()
`

      resultsDiv.innerHTML = `
        <div class="space-y-4">
          <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6">
            <h3 class="text-xl font-bold text-green-900 mb-3">‚úÖ Successfully Recovered ${meetings.length} Meetings!</h3>
            ${meetings.map(m => `
              <div class="bg-white rounded p-3 mb-2">
                <div class="font-medium">${m.title}</div>
                <div class="text-sm text-gray-600">
                  ${m.wordCount} words ‚Ä¢ ${m.speakerCount} speakers ‚Ä¢ ${m.duration}s duration
                </div>
              </div>
            `).join('')}
          </div>

          <div class="bg-blue-50 border border-blue-300 rounded-lg p-6">
            <h3 class="font-bold text-blue-900 mb-3">üìã Copy & Paste This Script:</h3>
            <textarea
              id="restoreScript"
              readonly
              class="w-full h-48 p-3 font-mono text-xs bg-white border rounded"
            >${script}</textarea>
            <button
              onclick="copyScript()"
              class="mt-3 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
            >
              üìã Copy Script
            </button>
          </div>

          <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <p class="text-sm text-yellow-700">
              <strong>Next Steps:</strong><br>
              1. Copy the script above<br>
              2. Open your app: <a href="https://sudhanshumalani.github.io/meetingflow-app" target="_blank" class="text-blue-600 underline">MeetingFlow App</a><br>
              3. Press F12 ‚Üí Console<br>
              4. Paste and press Enter<br>
              5. Refresh (F5)
            </p>
          </div>
        </div>
      `
    }

    function copyScript() {
      const textarea = document.getElementById('restoreScript')
      textarea.select()
      document.execCommand('copy')
      alert('‚úÖ Script copied to clipboard!\n\nNow:\n1. Open your app\n2. F12 ‚Üí Console\n3. Paste & Enter\n4. Refresh (F5)')
    }
  </script>
</body>
</html>
