<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recover Meetings - MeetingFlow</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-6">🔄 Meeting Recovery Tool</h1>

      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-700">
              This tool will recover your two meetings from Assembly AI servers and import them into your MeetingFlow app.
            </p>
          </div>
        </div>
      </div>

      <div class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Assembly AI API Key
          </label>
          <input
            type="password"
            id="apiKey"
            placeholder="Enter your Assembly AI API key"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">From your .env file: VITE_ASSEMBLYAI_API_KEY</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Transcript IDs to Recover
          </label>
          <div class="bg-gray-50 p-3 rounded border border-gray-200 text-sm font-mono">
            <div>1. 4f8c4e19-44b1-4c99-b9bb-8549d4faf3ad</div>
            <div>2. 2cad96ef-4bf1-481f-9de9-2c0a22da0e27</div>
          </div>
        </div>
      </div>

      <button
        onclick="recoverMeetings()"
        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg"
      >
        🔄 Recover Meetings
      </button>

      <div id="progress" class="mt-6 hidden">
        <div class="bg-gray-100 rounded-lg p-4">
          <div class="flex items-center space-x-3 mb-2">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            <span class="text-gray-700 font-medium">Recovering meetings...</span>
          </div>
          <div id="progressLog" class="text-sm text-gray-600 space-y-1 max-h-64 overflow-y-auto"></div>
        </div>
      </div>

      <div id="results" class="mt-6 hidden">
        <div id="resultsContent"></div>
      </div>
    </div>
  </div>

  <script>
    const transcriptIds = [
      '4f8c4e19-44b1-4c99-b9bb-8549d4faf3ad',
      '2cad96ef-4bf1-481f-9de9-2c0a22da0e27'
    ]

    function log(message, type = 'info') {
      const logDiv = document.getElementById('progressLog')
      const line = document.createElement('div')
      line.textContent = message
      line.className = type === 'error' ? 'text-red-600' :
                       type === 'success' ? 'text-green-600' : 'text-gray-600'
      logDiv.appendChild(line)
      logDiv.scrollTop = logDiv.scrollHeight
      console.log(message)
    }

    async function fetchTranscript(transcriptId, apiKey) {
      log(`📥 Fetching transcript: ${transcriptId}`)

      const response = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
        headers: { authorization: apiKey }
      })

      if (!response.ok) {
        throw new Error(`Failed to fetch transcript: ${response.statusText}`)
      }

      const transcript = await response.json()

      if (transcript.status === 'completed') {
        log(`✅ Transcript fetched: ${transcript.text?.split(' ').length || 0} words`, 'success')
        return transcript
      } else if (transcript.status === 'error') {
        throw new Error(`Transcript failed: ${transcript.error}`)
      } else {
        throw new Error(`Transcript status: ${transcript.status}`)
      }
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8)
        return v.toString(16)
      })
    }

    function convertToMeeting(transcript, transcriptId) {
      const now = new Date().toISOString()

      const speakers = new Set()
      if (transcript.utterances) {
        transcript.utterances.forEach(u => speakers.add(u.speaker))
      }

      let formattedTranscript = ''
      if (transcript.utterances && transcript.utterances.length > 0) {
        formattedTranscript = transcript.utterances.map(u =>
          `[Speaker ${u.speaker}]: ${u.text}`
        ).join('\n\n')
      } else {
        formattedTranscript = transcript.text || ''
      }

      const meeting = {
        id: generateUUID(),
        title: `Recovered Meeting - ${new Date().toLocaleDateString()}`,
        description: `Recovered from Assembly AI (ID: ${transcriptId})`,
        date: new Date().toISOString().split('T')[0],
        audioTranscript: formattedTranscript, // Main field for audio transcript
        transcript: formattedTranscript, // Backup field
        duration: transcript.audio_duration ? Math.round(transcript.audio_duration) : null,
        wordCount: transcript.text ? transcript.text.split(' ').length : 0,
        speakerCount: speakers.size,
        confidence: transcript.confidence,
        createdAt: now,
        updatedAt: now,
        lastSaved: now,
        originalInputs: {
          audioTranscript: formattedTranscript, // CRITICAL: This is what Meeting view looks for!
          manualText: '',
          ocrText: ''
        },
        metadata: {
          recovered: true,
          recoveredAt: now,
          assemblyAIId: transcriptId,
          originalStatus: transcript.status,
          speakerLabels: transcript.utterances ?
            Array.from(speakers).map(s => `Speaker ${s}`) : []
        }
      }

      if (transcript.utterances) {
        meeting.utterances = transcript.utterances
        meeting.words = transcript.words
        meeting.speakerData = {
          utterances: transcript.utterances,
          speakers_detected: speakers.size
        }
      }

      return meeting
    }

    function saveMeetingToStorage(meeting) {
      const existingMeetings = JSON.parse(localStorage.getItem('meetingflow_meetings') || '[]')

      const alreadyExists = existingMeetings.some(m =>
        m.metadata?.assemblyAIId === meeting.metadata.assemblyAIId
      )

      if (alreadyExists) {
        log('⚠️ Meeting already recovered, skipping duplicate', 'info')
        return false
      }

      existingMeetings.unshift(meeting)
      localStorage.setItem('meetingflow_meetings', JSON.stringify(existingMeetings))

      log('✅ Meeting saved to localStorage', 'success')
      return true
    }

    async function recoverMeetings() {
      const apiKey = document.getElementById('apiKey').value.trim()

      if (!apiKey) {
        alert('Please enter your Assembly AI API key')
        return
      }

      document.getElementById('progress').classList.remove('hidden')
      document.getElementById('results').classList.add('hidden')
      document.getElementById('progressLog').innerHTML = ''

      const results = []

      for (const transcriptId of transcriptIds) {
        try {
          log(`\n📋 Processing: ${transcriptId}`)

          const transcript = await fetchTranscript(transcriptId, apiKey)
          const meeting = convertToMeeting(transcript, transcriptId)
          const saved = saveMeetingToStorage(meeting)

          if (saved) {
            results.push({
              success: true,
              transcriptId,
              meeting,
              words: meeting.wordCount,
              speakers: meeting.speakerCount
            })
            log(`✅ Successfully recovered: ${meeting.wordCount} words, ${meeting.speakerCount} speakers`, 'success')
          } else {
            results.push({ success: false, transcriptId, error: 'Already exists' })
          }

        } catch (error) {
          log(`❌ Failed: ${error.message}`, 'error')
          results.push({ success: false, transcriptId, error: error.message })
        }
      }

      showResults(results)
    }

    function showResults(results) {
      document.getElementById('progress').classList.add('hidden')
      document.getElementById('results').classList.remove('hidden')

      const successful = results.filter(r => r.success).length
      const failed = results.filter(r => !r.success).length

      let html = `
        <div class="bg-white rounded-lg border p-6">
          <h2 class="text-xl font-bold mb-4">Recovery Complete!</h2>
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-green-50 p-4 rounded border border-green-200">
              <div class="text-3xl font-bold text-green-600">${successful}</div>
              <div class="text-sm text-green-800">Recovered</div>
            </div>
            <div class="bg-red-50 p-4 rounded border border-red-200">
              <div class="text-3xl font-bold text-red-600">${failed}</div>
              <div class="text-sm text-red-800">Failed</div>
            </div>
          </div>
      `

      if (successful > 0) {
        html += `
          <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
            <p class="text-blue-700">
              ✅ Meetings recovered successfully! Please <strong>refresh your MeetingFlow app</strong> to see the recovered meetings.
            </p>
          </div>
        `

        html += `<div class="space-y-2">`
        results.filter(r => r.success).forEach(r => {
          html += `
            <div class="bg-gray-50 p-3 rounded border border-gray-200">
              <div class="font-medium text-gray-900">${r.meeting.title}</div>
              <div class="text-sm text-gray-600">
                ${r.words} words • ${r.speakers} speakers • ${r.meeting.duration}s duration
              </div>
            </div>
          `
        })
        html += `</div>`
      }

      html += `</div>`

      document.getElementById('resultsContent').innerHTML = html
    }
  </script>
</body>
</html>
